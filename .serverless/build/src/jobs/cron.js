"use strict";var c=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var h=(t,e)=>{for(var n in e)c(t,n,{get:e[n],enumerable:!0})},d=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of u(e))!g.call(t,o)&&o!==n&&c(t,o,{get:()=>e[o],enumerable:!(r=m(e,o))||r.enumerable});return t};var p=t=>d(c({},"__esModule",{value:!0}),t);var b={};h(b,{runDailyJob:()=>S});module.exports=p(b);var l=require("@prisma/client"),y=new l.PrismaClient,s=class{static async getUsersForNotification(){try{return(await y.reminder.findMany({where:{is_subscribed:!0,user:{email:{not:void 0}}},select:{user:{select:{email:!0,name:!0}}}})).map(r=>({email:r.user.email,name:r.user.name}))}catch(e){throw console.error("Prisma Error:",e),e}}};var i=require("@aws-sdk/client-ses"),f=new i.SESClient({region:"ap-southeast-1"}),a=class{static async sendDailyUpdate(e,n){let r={Source:process.env.SES_FROM_EMAIL||"tranphuonghuyen2005@gmail.com",Destination:{ToAddresses:[e]},Message:{Subject:{Data:"Th\xF4ng b\xE1o t\u1EEB SorcererXStreme",Charset:"UTF-8"},Body:{Html:{Data:`<h3>Xin ch\xE0o ${n},</h3><p>\u0110\xE2y l\xE0 th\xF4ng b\xE1o t\u1EEB SorcererXStreme g\u1EEDi \u0111\u1EBFn b\u1EA1n.</p>`,Charset:"UTF-8"}}}};try{return await f.send(new i.SendEmailCommand(r)),!0}catch(o){return console.error(`G\u1EEDi l\u1ED7i t\u1EDBi ${e}:`,o),!1}}};var S=async t=>{console.log("--- B\u1EAFt \u0111\u1EA7u Cron Job ---");try{let e=await s.getUsersForNotification();if(console.log(`T\xECm th\u1EA5y ${e.length} ng\u01B0\u1EDDi d\xF9ng.`),e.length===0)return;let n=e.map(r=>{if(r.email)return a.sendDailyUpdate(r.email,r.name||"B\u1EA1n")});return await Promise.allSettled(n),console.log("--- Ho\xE0n th\xE0nh Cron Job ---"),{statusCode:200,body:JSON.stringify({message:"\u0110\xE3 g\u1EEDi th\xF4ng b\xE1o th\xE0nh c\xF4ng"})}}catch(e){console.error("L\u1ED7i Cron Job:",e)}};0&&(module.exports={runDailyJob});
